<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Topics &mdash; kerchunk  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Contributing to kerchunk" href="contributing.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            kerchunk
              <img src="_static/kerchunk.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                9999
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="test_example.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="detail.html">Detailed description</a></li>
<li class="toctree-l1"><a class="reference internal" href="cases.html">Case studies</a></li>
<li class="toctree-l1"><a class="reference internal" href="spec.html">References specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="beyond.html">Beyond Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="nonzarr.html">Non-zarr uses</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to kerchunk</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-dask">Using Dask</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#simple-parallel">Simple parallel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tree-reduction">Tree reduction</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#archive-files">Archive Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parquet-storage">Parquet Storage</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">kerchunk</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Advanced Topics</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/advanced.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-topics">
<h1>Advanced Topics<a class="headerlink" href="#advanced-topics" title="Link to this heading"></a></h1>
<section id="using-dask">
<h2>Using Dask<a class="headerlink" href="#using-dask" title="Link to this heading"></a></h2>
<p>Scanning and combining datasets can be computationally intensive and may
require a lot of bandwidth for some data formats. Where the target data
contains many input files, it makes sense to parallelise the job with
dask and maybe distribute the workload on a cluster to get additional
CPUs and network performance.</p>
<section id="simple-parallel">
<h3>Simple parallel<a class="headerlink" href="#simple-parallel" title="Link to this heading"></a></h3>
<p>The simplest case is for processing many individual files in parallel.
Let’s say you have a list of input files; you will need to encapsulate
the processing on each in a single function. In this mode, it is typical
to save the single-file outputs to files, although returning them is OK
too (especially if you mean to combine them immediately).</p>
<p>Here is an example for HDF5 files. The caller should make sure the
storage options and any parameters needed for the transformer are in place.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ujson</span><span class="o">,</span> <span class="nn">fsspec</span><span class="o">,</span> <span class="nn">dask</span>

<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">,</span> <span class="n">storage_options_in</span><span class="o">=</span><span class="p">{},</span> <span class="n">storage_options_out</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">transformer</span> <span class="o">=</span> <span class="n">kerchunk</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">SingleHdf5ToZarr</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options_in</span><span class="p">)</span>
    <span class="n">refs</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">translate</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options_out</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">ujson</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">process</span><span class="p">)(</span><span class="n">u</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">infilenames</span><span class="p">,</span> <span class="n">outfilenames</span><span class="p">)]</span>
<span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="tree-reduction">
<h3>Tree reduction<a class="headerlink" href="#tree-reduction" title="Link to this heading"></a></h3>
<p>In some cases, the combine process can itself be slow or memory hungry.
In such cases, it is useful to combine the single-file reference sets in
batches (which reduce a lot of redundancy between them) and then
combine the results of the batches. This technique is known as tree
reduction. An example of doing this by hand can be seen <a class="reference external" href="https://gist.github.com/peterm790/5f901453ed7ac75ac28ed21a7138dcf8">here</a>.</p>
<p>We also provide <code class="xref py py-func docutils literal notranslate"><span class="pre">kerchunk.combine.auto_dask()</span></code> as a convenience. This
function is a one-stop call to process the individual inputs, combine
them in batches, and then combine the results of those batches into a
final combined references set.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">auto_dask</span></code> function takes a number of dicts as arguments, and users
should consult the docstrings of the specific class which decodes the
input files, and also of <code class="xref py py-class docutils literal notranslate"><span class="pre">kerchunk.combine.MultiZarrToZarr</span></code>. Note that
any “preprocessing” for <code class="docutils literal notranslate"><span class="pre">MultiZarrToZarr</span></code> will be performed <em>before</em> the
batch stage, and any “postprocessing” only <em>after</em> the final combine.</p>
</section>
</section>
<section id="archive-files">
<h2>Archive Files<a class="headerlink" href="#archive-files" title="Link to this heading"></a></h2>
<p>It is often convenient to distribute datasets by wrapping multiple files
into an archive, ZIP or TAR. If those files are of formats supported by
<code class="docutils literal notranslate"><span class="pre">kerchunk</span></code>, they can be directly scanned with something like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">transformer</span> <span class="o">=</span> <span class="n">kerchunk</span><span class="o">.</span><span class="n">netCDF3</span><span class="o">.</span><span class="n">NetCDF3ToZarr</span><span class="p">(</span>
    <span class="s2">&quot;tar://myfile.nc::file://archive.tar&quot;</span><span class="p">,</span>
    <span class="n">inline_threshold</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">translate</span><span class="p">()</span>
</pre></div>
</div>
<p>where “myfile.nc” is a member file of the local archive.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We have turned off inlining here (it can be done
later with <code class="xref py py-func docutils literal notranslate"><span class="pre">kerchunk.utils.do_inline()</span></code>; support for this
will come later.</p>
</div>
<p>At this point, the
generated references will contain URLs “tar://myfile.nc::file://archive.tar”,
which are problematic for loading, so we can transform them to point to
ranges in the original tar file instead, and then transform back to
nominal form, ready to use. We may automate these steps in the future.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">out2</span> <span class="o">=</span> <span class="n">kerchunk</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">dereference_archives</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="c1"># optional out2 = kerchunk.utils.do_inline(out2, 100)</span>
<span class="n">final</span> <span class="o">=</span> <span class="n">kerchunk</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">consolidate</span><span class="p">(</span><span class="n">out2</span><span class="p">)</span>
</pre></div>
</div>
<p>Now the references are all “<a class="reference external" href="file://archive.tar">file://archive.tar</a>”, and the reference set
can be used directly or in combining.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For ZIP archives, only uncompressed members can be accessed this way</p>
</div>
</section>
<section id="parquet-storage">
<h2>Parquet Storage<a class="headerlink" href="#parquet-storage" title="Link to this heading"></a></h2>
<p>JSON is very convenient as a storage format for references, because it is
simple, human-readable and ubiquitously supported. However, it is not the most
efficient in terms of storage size of parsing speed. For python, in particular,
it comes with the added downside of repeated strings becoming separate python
string instances, greatly inflating memory footprint at load time.</p>
<p>To overcome these problems, and in particular keep down the memory use for the
end-user of kerchunked data, we can convert references to be stored in parquet,
and use them with <code class="docutils literal notranslate"><span class="pre">fsspec.implementations.reference.ReferenceFileSystem</span></code>,
an alternative new implementation designed to work only with parquet input.</p>
<p>The principle benefits of the parquet path are:</p>
<ul class="simple">
<li><p>much more compact storage, typically 2x smaller than compressed JSON or 10x
smaller than uncompressed</p></li>
<li><p>correspondingly faster instantiation of a filesystem, since much of that time
is taken by loading in the bytes of the references</p></li>
<li><p>smaller in-memory size (e.g., a python int requires 28 bytes, but an int in
an array needs 4 or 8.</p></li>
<li><p>optional lazy loading, by partitioning the references into files by key; only
the variables you actually access need to have their references loaded</p></li>
<li><p>optional dictionary encoding of URLs in the case that there are may repeated
URLs (many references per target file). In this format, each unique URL is only
stored in memory once.</p></li>
</ul>
<p>The only access point to the new parquet storage is
<code class="xref py py-func docutils literal notranslate"><span class="pre">kerchunk.df.refs_to_dataframe()</span></code>, which transforms an existing kerchunk
reference set (in memory as dicts or in a JSON file) to parquet. Careful reading
of the docstring is recommended, to understand the options. More options may
be added.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For now, <code class="xref py py-class docutils literal notranslate"><span class="pre">kerchunk.combine.MultiZarrToZarr</span></code> only operates on JSON/dict
input. Therefore, <code class="docutils literal notranslate"><span class="pre">refs_to_dataframe</span></code> can only be used on the final output
reference set. For a very large merge of many/large inputs, this may mean
that the combine step requires a lot of memory, as will converting the
output to parquet. However, the end-user should be able to access data via
these references with much smaller  memory requirements.</p>
</div>
<p>A concrete workflow may be something like the following. Note that
<code class="xref py py-func docutils literal notranslate"><span class="pre">kerchunk.combine.auto_dask()</span></code> can execute the first three stages in
one go and may be faster, if you have a Dask cluster available.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">kerchunk</span> <span class="kn">import</span> <span class="n">hdf</span><span class="p">,</span> <span class="n">combine</span><span class="p">,</span> <span class="n">df</span>
<span class="kn">import</span> <span class="nn">fsspec.implementations.reference</span>
<span class="kn">from</span> <span class="nn">fsspec.implementations.reference</span> <span class="kn">import</span> <span class="n">LazyReferenceMapper</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="n">files</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">location_of_data</span><span class="p">)</span>

<span class="c1"># Create LazyReferenceMapper to pass to MultiZarrToZarr</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">filesystem</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;combined.parq&quot;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">LazyReferenceMapper</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;combined.parq&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>

<span class="c1"># Create references from input files</span>
<span class="n">single_ref_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdf</span><span class="o">.</span><span class="n">SingleHdf5ToZarr</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

<span class="n">out_dict</span> <span class="o">=</span> <span class="n">MultiZarrToZarr</span><span class="p">(</span>
 <span class="n">single_ref_sets</span><span class="p">,</span>
 <span class="n">remote_protocol</span><span class="o">=</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span>
 <span class="n">concat_dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
 <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">()</span>

<span class="n">out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">refs_to_dataframe</span><span class="p">(</span><span class="n">out_dict</span><span class="p">,</span> <span class="s2">&quot;combined.parq&quot;</span><span class="p">)</span>

<span class="n">fs</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">implementations</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">ReferenceFileSystem</span><span class="p">(</span>
    <span class="s2">&quot;combined.parq&quot;</span><span class="p">,</span> <span class="n">remote_protocol</span><span class="o">=</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">target_protocol</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(),</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;zarr&quot;</span><span class="p">,</span>
    <span class="n">backend_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;consolidated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>At this point, xarray has loaded the metadata and coordinates only, so the
main reference files corresponding to the data variables have not been touched.
Even for a very large reference set, the memory use at this point should be &lt;500MB.</p>
<p>As you access the variables of <code class="docutils literal notranslate"><span class="pre">ds</span></code>, they will be loaded on demand and cached.
If using <code class="docutils literal notranslate"><span class="pre">dask</span></code>, workers will also only load those references they need.</p>
<script data-goatcounter="https://kerchunk.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script></section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="contributing.html" class="btn btn-neutral float-left" title="Contributing to kerchunk" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Martin Durant.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>